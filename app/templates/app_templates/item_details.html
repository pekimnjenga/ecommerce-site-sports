{% extends "app_templates/base.html" %}
{% block title %}<title>Item Details</title>{% endblock title %}
{% load static %}
{% load cart_dict %}
{% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-md-6">
      <!-- Carousel -->
      <div id="carousel{{ item.id }}" class="carousel slide border rounded shadow-sm" data-bs-ride="carousel">
        <div class="carousel-inner">
          {% if item.images.count > 0 %}
          {% for image in item.images.all %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <img src="{{ image.image_url }}" class="d-block w-100 rounded"
              style="max-height: 400px; object-fit: contain" alt="{{ item.name }}" />
          </div>
          {% endfor %}
          {% else %}
          <div class="carousel-item active">
            <img src="{% static 'app_templates/images/default.png' %}" class="d-block w-100 rounded"
              style="max-height: 400px; object-fit: contain" alt="{{ item.name }}" />
          </div>
          {% endif %}
        </div>

        {% if item.images.count > 1 %}
        <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ item.id }}"
          data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ item.id }}"
          data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
        {% endif %}
      </div>
    </div>

    <div class="col-md-6">
      <h2 class="fw-bold">{{ item.name }}</h2>
      <p class="text-muted mb-1">
        <strong>Price:</strong> Ksh {{ item.price }}
      </p>
      <p class="mb-4">{{ item.description }}</p>

      {% if user.is_authenticated %}
      <form method="POST" action="{% url 'add_to_cart' item.id %}" class="mt-3">
        {% csrf_token %}

        <!-- Size Selection -->
        {% if item.sizes %}
        <label class="fw-bold mb-2">Select Size:</label>
        <div class="btn-group mt-2 mb-3" role="group">
          {% with item_id_str=item.id|stringformat:"s" %}
          {% with selected_size=selected_sizes|get_item:item_id_str %}
          {% for size in item.sizes|split_by_comma %}
          <input type="radio" class="btn-check" name="size" id="size{{ forloop.counter }}" value="{{ size }}"
            autocomplete="off" {% if selected_size == size %}checked{% endif %}>
          <label class="btn btn-outline-success btn-sm" for="size{{ forloop.counter }}">
            {{ size }}
          </label>
          {% endfor %}
          {% endwith %}
          {% endwith %}
        </div>
        {% endif %}


        <!-- Quantity + Add to Cart -->
        <div class="input-group mb-3" style="max-width: 220px;">
          <input type="number" name="quantity" value="1" min="1" max="{{ item.stock }}" class="form-control text-center"
            required>
          <button type="submit" class="btn btn-success">Add to Cart</button>
        </div>
      </form>
      {% else %}
      <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-success mt-3">
        Login to add to cart
      </a>
      {% endif %}

      <!-- Shipping Policy Section -->
      <div class="mt-4">
        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#shippingPolicy"
          aria-expanded="false" aria-controls="shippingPolicy">
          Shipping Policy
        </button>
        <div class="collapse mt-2" id="shippingPolicy">
          <div class="card card-body">
            You will receive your order after 3 working days from the day of purchase at the location which you will
            specify during the purchase.
          </div>
        </div>
      </div>

      <!-- Return Policy Section -->
      <div class="mt-3">
        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#returnPolicy"
          aria-expanded="false" aria-controls="returnPolicy">
          Return Policy
        </button>
        <div class="collapse mt-2" id="returnPolicy">
          <div class="card card-body">
            Returns are accepted within 7 days of delivery. Items must be in their original condition and packaging.
            Reach out to our team for further assistance.
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock content %}